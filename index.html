<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay DDP Camera Export Calc</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- å·¦ã‚«ãƒ©ãƒ ï¼šãƒ¡ã‚¤ãƒ³å…¥åŠ› -->
        <div class="lg:col-span-2 space-y-6">
            <header class="mb-6">
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    <span class="bg-blue-600 text-white p-1 rounded-md text-sm">eBay</span>
                    DDP è¼¸å‡ºè¨ˆç®—ãƒ„ãƒ¼ãƒ«
                </h1>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-md font-semibold mb-4 flex items-center gap-2 text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        åŸºæœ¬ãƒ»ã‚³ã‚¹ãƒˆè¨­å®š
                    </h2>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500">ä»•å…¥ã‚Œä¾¡æ ¼ (å††ãƒ»ç¨è¾¼)</label>
                            <input type="number" id="costJpy" class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-50 p-2 border focus:ring-blue-500 focus:border-blue-500 text-sm" value="45000">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 flex justify-between">
                                    <span>ç‚ºæ›¿ ($/Â¥)</span>
                                    <span id="rateStatus" class="text-[10px] text-blue-500">...</span>
                                </label>
                                <input type="number" id="rate" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-50 p-2 border text-sm" value="150">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500">é€æ–™å®Ÿè²» ($)</label>
                                <input type="number" id="actualShip" class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-50 p-2 border text-sm" value="30">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-500">é–¢ç¨ç‡ (%)</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="range" id="tariffRateRange" min="0" max="30" step="0.1" value="20" class="flex-grow h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="tariffRate" step="0.1" class="w-16 rounded-lg border-gray-300 bg-gray-50 p-1 text-center border text-xs" value="20">
                            </div>
                        </div>

                        <!-- åºƒå‘Šè²»è¨­å®š (New) -->
                        <div class="pt-2 border-t border-gray-100">
                            <label class="block text-xs font-bold text-purple-600 flex justify-between">
                                <span>åºƒå‘Šè²» (Ad Standard)</span>
                                <span class="text-[10px] font-normal text-gray-400">å£²ä¸Šç·é¡ã«ã‹ã‹ã‚Šã¾ã™</span>
                            </label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="range" id="adRateRange" min="0" max="30" step="0.1" value="2" class="flex-grow h-1.5 bg-purple-100 rounded-lg appearance-none cursor-pointer accent-purple-600">
                                <div class="relative">
                                    <input type="number" id="adRate" step="0.1" class="w-16 rounded-lg border-purple-200 bg-purple-50 p-1 text-center border text-xs font-bold text-purple-700" value="2">
                                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] text-purple-300 hidden">%</span>
                                </div>
                            </div>
                        </div>

                        <div class="pt-3 border-t border-gray-100">
                            <label class="block text-sm font-bold text-blue-700">ç›®æ¨™åˆ©ç›Šç‡ (%) ã‹ã‚‰é€†ç®—</label>
                            <input type="number" id="targetMargin" class="mt-1 block w-full rounded-lg border-blue-200 bg-blue-50 p-2 border focus:ring-blue-500 focus:border-blue-500 font-bold text-blue-800 text-lg" value="15">
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-500">è²©å£²å¸Œæœ›ä¾¡æ ¼ ($ - æœ¬ä½“ã®ã¿)</label>
                            <input type="number" id="basePrice" class="mt-1 block w-full rounded-lg border-gray-300 bg-gray-50 p-2 border font-bold text-base" value="500">
                        </div>
                    </div>
                </div>

                <!-- å‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="space-y-4">
                    <!-- eBayè¨­å®šå€¤ -->
                    <div class="bg-amber-50 p-5 rounded-2xl shadow-sm border border-amber-200">
                        <h2 class="text-sm font-bold text-amber-900 mb-3 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            eBayå‡ºå“è¨­å®šå€¤
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <p class="text-xs text-amber-700 mb-0.5">Start Price (æœ¬ä½“+é€æ–™)</p>
                                <p id="resStartPrice" class="text-3xl font-bold text-amber-900">$0.00</p>
                            </div>
                            <hr class="border-amber-200">
                            <div>
                                <p class="text-xs text-amber-700 mb-0.5">è¨­å®šã™ã¹ãé–¢ç¨é¡ (Rate Table)</p>
                                <p id="resTariff" class="text-2xl font-bold text-amber-900">$0.00</p>
                                <p id="tariffNote" class="text-[10px] text-amber-600">â€»å•†å“ä»£é‡‘ã®20.0%ç›¸å½“</p>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ©ç›Šçµæœ -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <h2 class="text-sm font-bold text-gray-700 mb-3">eBay åˆ©ç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between text-gray-500">
                                <span>ãƒã‚¤ãƒ¤ãƒ¼æ”¯æ‰•ç·é¡</span>
                                <span id="resTotalPaid">$0.00</span>
                            </div>
                            <div class="flex justify-between text-red-500">
                                <span>eBayæ‰‹æ•°æ–™(15%)+åºƒå‘Šè²»</span>
                                <span id="resTotalFee">-$0.00</span>
                            </div>
                            <div class="flex justify-between text-red-500">
                                <span>é€æ–™ãƒ»é–¢ç¨åˆè¨ˆ</span>
                                <span id="resTotalExpense">-$0.00</span>
                            </div>
                            <hr class="border-dashed border-gray-200 my-2">
                            <div class="flex justify-between items-end">
                                <span class="text-green-700 font-bold">ç´”åˆ©ç›Š (å††)</span>
                                <span id="resFinalProfit" class="text-2xl font-black text-green-700">0</span>
                            </div>
                            <div class="flex justify-between items-center text-xs mt-1">
                                <span class="text-gray-400">åˆ©ç›Šç‡</span>
                                <span id="resProfitMargin" class="font-bold text-gray-600">0.0%</span>
                            </div>
                            <div class="mt-2 bg-blue-50 p-2 rounded text-center">
                                <p class="text-[10px] text-blue-600">æ¶ˆè²»ç¨é‚„ä»˜è¦‹è¾¼ (åˆ©ç›Šåˆ¥æ )</p>
                                <p id="resTaxRefund" class="text-sm font-bold text-blue-700">0 å††</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ã‚«ãƒ©ãƒ ï¼šãƒ¤ãƒ•ã‚ªã‚¯ä½µå£²è¨ˆç®— (New) -->
        <div class="lg:col-span-1 bg-yellow-50 border border-yellow-200 rounded-3xl p-6 h-fit sticky top-4">
            <header class="mb-4 pb-4 border-b border-yellow-200">
                <h2 class="text-lg font-bold text-yellow-900 flex items-center gap-2">
                    <span class="text-xl">ğŸ‡¯ğŸ‡µ</span>
                    ãƒ¤ãƒ•ã‚ªã‚¯ä½µå£²è¨ˆç®—
                </h2>
                <p class="text-[10px] text-yellow-700 mt-1">â€»eBayã®è¨ˆç®—ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“</p>
            </header>

            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-yellow-800 mb-1">ç›®æ¨™åˆ©ç›Šç‡ (%)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="yahooTargetMargin" class="block w-full rounded-lg border-yellow-300 bg-white p-2 border text-yellow-900 font-bold text-center" value="15">
                        <button onclick="syncMargin()" class="text-[10px] whitespace-nowrap bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-2 py-2 rounded transition-colors" title="eBayã®åˆ©ç›Šç‡ã‚’ã‚³ãƒ”ãƒ¼">
                            eBayã‹ã‚‰<br>ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-yellow-800 mb-1">å›½å†…é€æ–™ (å††ãƒ»å‡ºå“è€…è² æ‹…)</label>
                    <input type="number" id="yahooShip" class="block w-full rounded-lg border-yellow-300 bg-white p-2 border text-sm" value="1000">
                </div>

                <div class="pt-4 border-t border-yellow-200 border-dashed">
                    <label class="block text-xs text-yellow-700 mb-1">ãƒ¤ãƒ•ã‚ªã‚¯å‡ºå“ä¾¡æ ¼ (å³æ±º)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-yellow-400 text-lg">Â¥</span>
                        <input type="text" id="yahooPrice" readonly class="block w-full rounded-xl border-2 border-yellow-400 bg-white pl-8 pr-4 py-3 font-black text-2xl text-yellow-900 shadow-sm" value="0">
                    </div>
                </div>

                <div class="bg-white/50 rounded-xl p-3 space-y-1 text-xs text-yellow-800">
                    <div class="flex justify-between">
                        <span>ã‚·ã‚¹ãƒ†ãƒ æ‰‹æ•°æ–™ (10%)</span>
                        <span id="yahooFee">-Â¥0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ä»•å…¥ã‚ŒåŸä¾¡</span>
                        <span id="yahooCostRef">-Â¥0</span>
                    </div>
                    <div class="flex justify-between border-t border-yellow-200 pt-1 mt-1 font-bold">
                        <span>äºˆæƒ³åˆ©ç›Š</span>
                        <span id="yahooProfit">Â¥0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ids = ['costJpy', 'rate', 'basePrice', 'actualShip', 'tariffRate', 'tariffRateRange', 'targetMargin', 'adRate', 'adRateRange', 'yahooTargetMargin', 'yahooShip'];
        const ebayFeeRate = 0.15;
        // ãƒ¤ãƒ•ã‚ªã‚¯æ‰‹æ•°æ–™ï¼ˆ10%å›ºå®šï¼‰
        const yahooFeeRate = 0.10; 

        async function fetchExchangeRate() {
            const statusEl = document.getElementById('rateStatus');
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                if (!response.ok) throw new Error('Network response failed');
                const data = await response.json();
                
                if (data && data.rates && data.rates.JPY) {
                    const rateInput = document.getElementById('rate');
                    // å€¤ãŒå…¥ã£ã¦ã„ãªã„ã€ã¾ãŸã¯åˆæœŸå€¤ã®å ´åˆã®ã¿æ›´æ–°
                    if(rateInput.value == "150") { 
                        rateInput.value = data.rates.JPY.toFixed(2);
                    }
                    statusEl.innerText = 'Auto';
                    update('rate');
                }
            } catch (error) {
                statusEl.innerText = 'Manual';
            }
        }

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼é€£å‹•
        document.getElementById('tariffRateRange').addEventListener('input', (e) => {
            document.getElementById('tariffRate').value = e.target.value;
            update('tariffRate');
        });
        document.getElementById('tariffRate').addEventListener('input', (e) => {
            document.getElementById('tariffRateRange').value = e.target.value;
            update('tariffRate');
        });
        document.getElementById('adRateRange').addEventListener('input', (e) => {
            document.getElementById('adRate').value = e.target.value;
            update('adRate');
        });
        document.getElementById('adRate').addEventListener('input', (e) => {
            document.getElementById('adRateRange').value = e.target.value;
            update('adRate');
        });

        // eBayåˆ©ç›Šç‡ã‚’ãƒ¤ãƒ•ã‚ªã‚¯ã«ã‚³ãƒ”ãƒ¼
        function syncMargin() {
            const ebayMargin = document.getElementById('targetMargin').value;
            document.getElementById('yahooTargetMargin').value = ebayMargin;
            updateYahoo();
        }

        function update(triggerId) {
            // --- Inputs ---
            const cost = parseFloat(document.getElementById('costJpy').value) || 0;
            const rate = parseFloat(document.getElementById('rate').value) || 0;
            const ship = parseFloat(document.getElementById('actualShip').value) || 0;
            
            const tRatePercent = parseFloat(document.getElementById('tariffRate').value) || 0;
            const tRate = tRatePercent / 100;
            
            const adRatePercent = parseFloat(document.getElementById('adRate').value) || 0;
            const adRate = adRatePercent / 100;

            let base = parseFloat(document.getElementById('basePrice').value) || 0;
            const targetM = parseFloat(document.getElementById('targetMargin').value) || 0;

            // --- Goal Seek (eBay) ---
            // å¤‰æ›´ãƒˆãƒªã‚¬ãƒ¼ãŒã€Œä¾¡æ ¼ç›´æ¥å…¥åŠ›ã€ä»¥å¤–ã®å ´åˆã€ç›®æ¨™åˆ©ç›Šç‡ã‹ã‚‰ä¾¡æ ¼ã‚’é€†ç®—
            if (['targetMargin', 'costJpy', 'rate', 'actualShip', 'tariffRate', 'adRate'].includes(triggerId)) {
                if (rate > 0) {
                    const m = targetM / 100;
                    const costUsd = cost / rate;
                    
                    // Formula derived for DDP pricing including Ad Fee:
                    // TotalFeeRate = ebayFeeRate + adRate
                    // Sales = Base + Ship + Tariff(Base)
                    // Profit = Sales * (1 - TotalFeeRate) - Ship - Tariff(Base) - CostUsd
                    // Margin = Profit / Sales
                    
                    const totalFeeRate = ebayFeeRate + adRate;
                    
                    // Numerator: Ship * (totalFeeRate + m) + CostUsd
                    const numerator = ship * (totalFeeRate + m) + costUsd;
                    // Denominator: (1 - totalFeeRate) - (totalFeeRate * tRate) - m * (1 + tRate)
                    const denominator = (1 - totalFeeRate) - (totalFeeRate * tRate) - (m * (1 + tRate));
                    
                    if (denominator > 0) {
                        base = numerator / denominator;
                        document.getElementById('basePrice').value = base.toFixed(2);
                    }
                }
            }

            // --- eBay Calculations ---
            const startPrice = base + ship; // eBayç”»é¢ä¸Šã®è¡¨ç¤ºä¾¡æ ¼ (Item + Shipping)
            const tariffFee = base * tRate; // DDPé–¢ç¨é¡
            const totalPaid = startPrice + tariffFee; // ãƒã‚¤ãƒ¤ãƒ¼ãŒæ”¯æ‰•ã†ç·é¡ï¼ˆç¨æŠœï¼‰ã¨ä»®å®šã€‚â€»å³å¯†ã«ã¯SalesTaxç­‰ã¯åˆ¥ã ãŒã€eBayæ‰‹æ•°æ–™ã¯TotalAmountã«ã‹ã‹ã‚‹
            
            // Fee: (Standard 15%) + (Ad Rate)
            const totalFeeRate = ebayFeeRate + adRate;
            const totalFeeAmount = totalPaid * totalFeeRate;
            
            const totalExpense = ship + tariffFee;
            const netUsd = totalPaid - totalFeeAmount - totalExpense; 
            const finalProfitJpy = (netUsd * rate) - cost;
            const totalSalesJpy = totalPaid * rate;
            const currentMargin = totalSalesJpy > 0 ? (finalProfitJpy / totalSalesJpy) * 100 : 0;

            // --- UI Update (eBay) ---
            document.getElementById('resStartPrice').innerText = `$${startPrice.toFixed(2)}`;
            document.getElementById('resTariff').innerText = `$${tariffFee.toFixed(2)}`;
            document.getElementById('tariffNote').innerText = `â€»å•†å“ä»£é‡‘ã®${tRatePercent.toFixed(1)}%ç›¸å½“`;
            
            const taxRefund = (cost / 1.1) * 0.1;
            document.getElementById('resTaxRefund').innerText = `${Math.floor(taxRefund).toLocaleString()} å††`;

            document.getElementById('resTotalPaid').innerText = `$${totalPaid.toFixed(2)}`;
            document.getElementById('resTotalFee').innerText = `-$${totalFeeAmount.toFixed(2)}`;
            document.getElementById('resTotalExpense').innerText = `-$${totalExpense.toFixed(2)}`;
            
            document.getElementById('resFinalProfit').innerText = Math.floor(finalProfitJpy).toLocaleString();
            document.getElementById('resProfitMargin').innerText = `${currentMargin.toFixed(1)} %`;

            // ä¾¡æ ¼ã‚’ç›´æ¥ã„ã˜ã£ãŸå ´åˆã€åˆ©ç›Šç‡è¡¨ç¤ºã‚’æ›´æ–°
            if (triggerId === 'basePrice') {
                document.getElementById('targetMargin').value = currentMargin.toFixed(1);
            }

            // --- Yahoo Update Call ---
            // eBayã®è¨ˆç®—ãŒçµ‚ã‚ã£ãŸå¾Œã€ãƒ¤ãƒ•ã‚ªã‚¯ã®è¨ˆç®—ã‚‚å›ã™ï¼ˆåŸä¾¡å¤‰æ›´ç­‰ã®åæ˜ ã®ãŸã‚ï¼‰
            // ãŸã ã—ãƒ¤ãƒ•ã‚ªã‚¯ã®åˆ©ç›Šç‡ã¯å‹æ‰‹ã«å¤‰ãˆãªã„
            updateYahoo();
        }

        // --- Yahoo Calculations ---
        function updateYahoo() {
            const cost = parseFloat(document.getElementById('costJpy').value) || 0;
            const yShip = parseFloat(document.getElementById('yahooShip').value) || 0;
            const yTargetM = parseFloat(document.getElementById('yahooTargetMargin').value) || 0;
            
            // Formula:
            // Price - (Price * 0.10) - Ship - Cost = Price * Margin
            // Price * (0.90 - Margin) = Cost + Ship
            
            const marginDec = yTargetM / 100;
            const denominator = (1 - yahooFeeRate) - marginDec;
            
            let yPrice = 0;
            if (denominator > 0) {
                yPrice = (cost + yShip) / denominator;
            }

            // å³æ±ºä¾¡æ ¼ãªã®ã§è¦‹ã‚„ã™ãä¸¸ã‚ã‚‹ (10å††å˜ä½ãªã©)
            yPrice = Math.ceil(yPrice / 10) * 10;
            
            const yFee = yPrice * yahooFeeRate;
            const yProfit = yPrice - yFee - yShip - cost;

            // UI Update (Yahoo)
            document.getElementById('yahooPrice').value = yPrice.toLocaleString();
            document.getElementById('yahooFee').innerText = `-Â¥${Math.floor(yFee).toLocaleString()}`;
            document.getElementById('yahooCostRef').innerText = `-Â¥${cost.toLocaleString()}`;
            document.getElementById('yahooProfit').innerText = `Â¥${Math.floor(yProfit).toLocaleString()}`;
            document.getElementById('yahooCostRef').innerText = `-Â¥${cost.toLocaleString()}`;
        }

        // Event Listeners
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', () => {
                // ãƒ¤ãƒ•ã‚ªã‚¯å›ºæœ‰ã®å…¥åŠ›ã®å ´åˆã¯ updateYahoo ã ã‘å‘¼ã¶ã€ãã‚Œä»¥å¤–ã¯å…¨ä½“
                if (id === 'yahooTargetMargin' || id === 'yahooShip') {
                    updateYahoo();
                } else {
                    update(id);
                }
            });
        });

        window.onload = () => {
            fetchExchangeRate();
            update('targetMargin');
            // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã¯ãƒ¤ãƒ•ã‚ªã‚¯ã®åˆ©ç›Šç‡ã‚’eBayã¨åˆã‚ã›ã¦ãŠãï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ä¾¿æ€§ã®ãŸã‚ï¼‰
            syncMargin();
        };
    </script>
</body>
</html>